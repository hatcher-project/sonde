!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define("HatcherSonde",t):e.HatcherSonde=t()}(this,function(){"use strict";function e(e){return e<1e3?e+"&micro;s":e<1e6?(e/1e3).toFixed(2)+"ms":(e/1e6).toFixed(2)+"s"}function t(e,t,o,i){var n=document.createElement(e);if(t&&(n.innerHTML=t),o)for(var s=o.split(" "),r=0;r<s.length;r++)n.classList.add(s[r]);if(i)for(var a in i)n.setAttribute(a,i[a]);return n}function o(e){if(null===c){c=[];var t=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(){var e=this;this.addEventListener("readystatechange",function(){if(e.readyState==XMLHttpRequest.DONE)for(var t=0;t<c.length;t++)c[t](e)},!1),t.apply(this,arguments)}}c.push(e)}function i(e,t){function o(o){var i=e.header.root.offsetHeight+t.offsetHeight,n=window.innerHeight-o.clientY-i;e.setHeight(n)}function i(){document.body.classList.remove("phpsonde-resizing"),document.removeEventListener("mouseup",i),document.removeEventListener("mousemove",o)}t.addEventListener("mousedown",function(e){e.preventDefault(),document.body.classList.add("phpsonde-resizing"),document.addEventListener("mousemove",o),document.addEventListener("mouseup",i)})}var n=function(e){var t=this;this.bar=e,this.root=document.createElement("header");var o=document.createElement("div");this.root.appendChild(o),o.innerHTML="logo",this.reportSelect=document.createElement("select");var i=document.createElement("div");i.classList.add("phpsonde-request-select"),i.appendChild(this.reportSelect),this.root.appendChild(i),this.reportSelect.addEventListener("change",function(){e.showReport(this.value)}),this.itemList=document.createElement("ul"),this.root.appendChild(this.itemList),o.addEventListener("click",function(){t.bar.toggle()}),e.on("reportAdded",function(o){var i=new Option(o.label,e.reports.length-1);t.reportSelect.options[t.reportSelect.options.length]=i}),e.on("showReport",function(o){t.showReport(e.reports[o])})};n.prototype.showReport=function(e){for(var t=this;this.itemList.lastChild;)t.itemList.removeChild(t.itemList.lastChild)},n.prototype.addPanelTab=function(e,o){var i=t("li",e,"phpsonde-panel-tab");this.itemList.appendChild(i);var n=this;1===this.itemList.children.length&&(i.classList.add("phpsonde-open"),o.classList.add("phpsonde-open")),i.addEventListener("click",function(){for(var e=n.bar.root.querySelectorAll(".phpsonde-panel-tab.phpsonde-open, .phpsonde-panel.phpsonde-open"),t=0;t<e.length;t++)e[t].classList.remove("phpsonde-open");i.classList.add("phpsonde-open"),o.classList.add("phpsonde-open"),n.bar.open()})};var s=function(e){if(!e||"string"!=typeof e)throw new Error("Event name should be a valid non-empty string!")},r=function(e){if("function"!=typeof e)throw new Error("Handler should be a function!")},a=function(e,t){if(e&&e.indexOf(t)<0)throw new Error('Event "'+t+'" is not allowed!')},d=Object.freeze({allowedEvents:Symbol("allowedEvents"),listeners:Symbol("listeners")}),p=function(e){if(void 0!==e&&!Array.isArray(e))throw new Error("Allowed events should be a valid array of strings!");this[d.listeners]=new Map,this[d.allowedEvents]=e};p.prototype.on=function(e,t){s(e),a(this[d.allowedEvents],e),r(t);var o=this[d.listeners].get(e);o||(o=new Set,this[d.listeners].set(e,o)),o.add(t)},p.prototype.once=function(e,t){var o=this;r(t);var i=function(n){o.off(e,i),t.call(o,n)};this.on(e,i)},p.prototype.off=function(e,t){s(e),a(this[d.allowedEvents],e),r(t);var o=this[d.listeners].get(e);o&&(o.delete(t),o.size||this[d.listeners].delete(e))},p.prototype.offAll=function(e){if(void 0===e)return void this[d.listeners].clear();s(e),a(this[d.allowedEvents],e);var t=this[d.listeners].get(e);t&&(t.clear(),this[d.listeners].delete(e))},p.prototype.emit=function(e,t){var o=this;s(e),a(this[d.allowedEvents],e);var i=this[d.listeners].get(e);i&&i.forEach(function(e){try{e.call(o,t)}catch(e){console.error(e)}})},p.prototype.hasListeners=function(e){return s(e),a(this[d.allowedEvents],e),this[d.listeners].has(e)},p.mixin=function(e,t){if(!e||"object"!=typeof e)throw new Error("Object to mix into should be valid object!");if(void 0!==t&&!Array.isArray(t))throw new Error("Allowed events should be a valid array of strings!");var o=new p(t);return["on","once","off","offAll","emit","hasListeners"].forEach(function(t){if(void 0!==e[t])throw new Error('Object to mix into already has "'+t+'" property defined!');"constructor"!==t&&(e[t]=o[t].bind(o))},o),e};var l=function(e){var o=this;this.bar=e,this.root=t("div",null,"phpsonde-panel phpsonde-timeline-panel"),this.header=t("header","Show "),this.root.appendChild(this.header),this.typeSelector=document.createElement("select"),this.header.appendChild(this.typeSelector),this.typeSelector.addEventListener("change",function(){o.filterType(this.value)}),this.itemList=document.createElement("ul"),this.root.appendChild(this.itemList),e.on("showReport",function(t){o.showReport(e.reports[t])})};l.prototype.showReport=function(o){for(var i=this;this.itemList.lastChild;)i.itemList.removeChild(i.itemList.lastChild);var n=o.data.duration;if(!n)throw"No valid duration for profile";this.bar.header.addPanelTab(e(n),this.root);for(var s={},r=0;r<o.data.profiles.length;r++)!function(r){var a=o.data.profiles[r],d=i.bar.profileTypes.hasOwnProperty(a.type)?a.type:"default",p=i.bar.profileTypes[d];s.hasOwnProperty(a.type)||(s[a.type]=p.label||a.type);var l=document.createElement("li");l.setAttribute("data-phpsonde-type",a.type);var h=document.createElement("div");l.appendChild(h),h.classList.add("phpsonde-summary");var c=document.createElement("div");c.classList.add("phpsonde-label"),h.appendChild(c),c.innerHTML=p.label||a.type;var u=document.createElement("div");u.classList.add("phpsonde-duration"),u.innerHTML=e(a.stop-a.start),h.appendChild(u);var f=document.createElement("div"),v=document.createElement("div");v.classList.add("phpsonde-timebar"),v.appendChild(f),h.appendChild(v);var m=100*a.start/n,y=100*(a.stop-a.start)/n;f.style["margin-left"]=m+"%",f.style.width=y>0?y+"%":"1px",p.color&&(f.style["background-color"]=p.color);var g=document.createElement("div");if(g.classList.add("phpsonde-details"),l.appendChild(g),a.data&&Object.keys(a.data).length>0){var L=t("div",null,"phpsonde-data-details");L.appendChild(t("h3","Details")),g.appendChild(L);var w=t("table");L.appendChild(w);for(var b in a.data){var E=t("tr");w.appendChild(E),E.appendChild(t("td",b)),E.appendChild(t("td",a.data[b]))}}var C=document.createElement("div");C.classList.add("phpsonde-stacktrace");var S=document.createElement("pre");S.innerHTML=a.trace,C.appendChild(t("h3","Stack Trace")),C.appendChild(S),g.appendChild(C),h.addEventListener("click",function(){g.classList.toggle("phpsonde-open")}),i.itemList.appendChild(l)}(r);for(;this.typeSelector.options.length;)i.typeSelector.options.remove(0);var a=new Option("All",-1);this.typeSelector.options[0]=a;for(var d in s){var p=new Option(s[d],d);i.typeSelector.options[i.typeSelector.options.length]=p}},l.prototype.filterType=function(e){var t=this;if(-1==e)for(var o=0;o<this.itemList.children.length;o++)t.itemList.children[o].classList.remove("phpsonde-hidden");else for(var i=0;i<this.itemList.children.length;i++){var n=t.itemList.children[i];n.getAttribute("data-phpsonde-type")===e?t.itemList.children[i].classList.remove("phpsonde-hidden"):t.itemList.children[i].classList.add("phpsonde-hidden")}};var h=function(e){var o=this;this.bar=e,this.root=t("div","","phpsonde-panel phpsonde-messages-panel"),this.itemList=t("ul"),this.root.appendChild(this.itemList),e.on("showReport",function(t){o.showReport(e.reports[t])})};h.prototype.showReport=function(e){for(var o=this;this.itemList.lastChild;)o.itemList.removeChild(o.itemList.lastChild);var i=e.data.messages;if(i){var n=t("span",i.length,"phpsonde-bubble");this.bar.header.addPanelTab("messages "+n.outerHTML,this.root);for(var s=0;s<i.length;s++){var r=i[s],a=t("li","&rsaquo; "+r.text,"bar");o.itemList.appendChild(a)}}};var c=null,u=function(){if(this.root=document.createElement("div"),this.root.classList.add("phpsonde"),this.sizer=t("div",null,"phpsonde-sizer"),this.root.appendChild(this.sizer),this.header=new n(this),this.root.appendChild(this.header.root),this.body=document.createElement("div"),this.body.classList.add("phpsonde-body"),this.root.appendChild(this.body),this.timeline=new l(this),this.body.appendChild(this.timeline.root),this.messages=new h(this),this.body.appendChild(this.messages.root),document.body.appendChild(this.root),this.reports=[],this.profileTypes={default:{color:"#AAA"}},i(this,this.sizer),localStorage){var e=localStorage.getItem("phpsonde_bodyheight");null!==e&&this.setHeight(e,!1);var o=localStorage.getItem("phpsonde_baropened");"true"!==o&&!0!==o||this.open()}var s=this;window.addEventListener("resize",function(){s.root.offsetHeight>window.innerHeight-50&&s.setHeight(window.innerHeight,!1)})};return u.prototype.setHeight=function(e,t){t=void 0===t||!0===t,e=parseInt(e,10)||300,e<0?e=10:e>window.innerHeight-50&&(e=window.innerHeight-50),this.body.style.height=e+"px",t&&localStorage&&localStorage.setItem("phpsonde_bodyheight",e)},u.prototype.open=function(){this.root.classList.add("phpsonde-open"),localStorage&&localStorage.setItem("phpsonde_baropened",!0)},u.prototype.close=function(){this.root.classList.remove("phpsonde-open"),localStorage&&localStorage.setItem("phpsonde_baropened",!1)},u.prototype.toggle=function(){this.root.classList.toggle("phpsonde-open"),localStorage&&localStorage.setItem("phpsonde_baropened",this.root.classList.contains("phpsonde-open"))},u.prototype.addProfileType=function(e,t){this.profileTypes[e]=t},u.prototype.addReport=function(e,t){var o={label:e,data:t};this.reports.push(o),this.emit("reportAdded",o),1===this.reports.length&&this.showReport(0)},u.prototype.showReport=function(e){this.emit("showReport",e)},u.prototype.listenForXhrReports=function(){var e=this;o(function(t){var o=t.getResponseHeader("phpsondereport");if(o){for(var i,n=1;i=t.getResponseHeader("phpsondereport-"+n);)o+=i,n++;try{o=atob(o),o=JSON.parse(o)}catch(e){console.error("Sonde was unable to decode data fro ajax request, please see the error below and report it on https://github.com/hatcher-project/sonde/issues with as much details as possible, including your browser version"),console.error(e)}if(o.reportBundle)for(var s=0;s<o.reportBundle.length;s++)e.addReport("xhr",o.reportBundle[s]);else e.addReport("XHR",o)}})},p.mixin(u.prototype),{Bar:u}});
//# sourceMappingURL=index.js.map
