!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define("HatcherSonde",t):e.HatcherSonde=t()}(this,function(){"use strict";function e(e){return e<1e3?e+"&micro;s":e<1e6?(e/1e3).toFixed(2)+"ms":(e/1e6).toFixed(2)+"s"}function t(e,t,o,i){var s=document.createElement(e);if(t&&(s.innerHTML=t),o)for(var r=o.split(" "),n=0;n<r.length;n++)s.classList.add(r[n]);if(i)for(var a in i)s.setAttribute(a,i[a]);return s}function o(e){if(null===h){h=[];var t=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(){var e=this;this.addEventListener("readystatechange",function(){if(e.readyState==XMLHttpRequest.DONE)for(var t=0;t<h.length;t++)h[t](e)},!1),t.apply(this,arguments)}}h.push(e)}var i=function(e){var t=this;this.bar=e,this.root=document.createElement("header");var o=document.createElement("div");this.root.appendChild(o),o.innerHTML="logo",this.reportSelect=document.createElement("select");var i=document.createElement("div");i.classList.add("phpsonde-request-select"),i.appendChild(this.reportSelect),this.root.appendChild(i),this.reportSelect.addEventListener("change",function(){e.showReport(this.value)}),this.itemList=document.createElement("ul"),this.root.appendChild(this.itemList),o.addEventListener("click",function(){t.bar.toggle()}),e.on("reportAdded",function(o){var i=new Option(o.label,e.reports.length-1);t.reportSelect.options[t.reportSelect.options.length]=i}),e.on("showReport",function(o){t.showReport(e.reports[o])})};i.prototype.showReport=function(e){for(var t=this;this.itemList.lastChild;)t.itemList.removeChild(t.itemList.lastChild)},i.prototype.addPanelTab=function(e,o){var i=t("li",e,"phpsonde-panel-tab");this.itemList.appendChild(i);var s=this;1===this.itemList.children.length&&(i.classList.add("phpsonde-open"),o.classList.add("phpsonde-open")),i.addEventListener("click",function(){for(var e=s.bar.root.querySelectorAll(".phpsonde-panel-tab.phpsonde-open, .phpsonde-panel.phpsonde-open"),t=0;t<e.length;t++)e[t].classList.remove("phpsonde-open");i.classList.add("phpsonde-open"),o.classList.add("phpsonde-open"),s.bar.open()})};var s=function(e){if(!e||"string"!=typeof e)throw new Error("Event name should be a valid non-empty string!")},r=function(e){if("function"!=typeof e)throw new Error("Handler should be a function!")},n=function(e,t){if(e&&e.indexOf(t)<0)throw new Error('Event "'+t+'" is not allowed!')},a=Object.freeze({allowedEvents:Symbol("allowedEvents"),listeners:Symbol("listeners")}),d=function(e){if(void 0!==e&&!Array.isArray(e))throw new Error("Allowed events should be a valid array of strings!");this[a.listeners]=new Map,this[a.allowedEvents]=e};d.prototype.on=function(e,t){s(e),n(this[a.allowedEvents],e),r(t);var o=this[a.listeners].get(e);o||(o=new Set,this[a.listeners].set(e,o)),o.add(t)},d.prototype.once=function(e,t){var o=this;r(t);var i=function(s){o.off(e,i),t.call(o,s)};this.on(e,i)},d.prototype.off=function(e,t){s(e),n(this[a.allowedEvents],e),r(t);var o=this[a.listeners].get(e);o&&(o.delete(t),o.size||this[a.listeners].delete(e))},d.prototype.offAll=function(e){if(void 0===e)return void this[a.listeners].clear();s(e),n(this[a.allowedEvents],e);var t=this[a.listeners].get(e);t&&(t.clear(),this[a.listeners].delete(e))},d.prototype.emit=function(e,t){var o=this;s(e),n(this[a.allowedEvents],e);var i=this[a.listeners].get(e);i&&i.forEach(function(e){try{e.call(o,t)}catch(e){console.error(e)}})},d.prototype.hasListeners=function(e){return s(e),n(this[a.allowedEvents],e),this[a.listeners].has(e)},d.mixin=function(e,t){if(!e||"object"!=typeof e)throw new Error("Object to mix into should be valid object!");if(void 0!==t&&!Array.isArray(t))throw new Error("Allowed events should be a valid array of strings!");var o=new d(t);return["on","once","off","offAll","emit","hasListeners"].forEach(function(t){if(void 0!==e[t])throw new Error('Object to mix into already has "'+t+'" property defined!');"constructor"!==t&&(e[t]=o[t].bind(o))},o),e};var p=function(e){var o=this;this.bar=e,this.root=t("div",null,"phpsonde-panel phpsonde-timeline-panel"),this.header=t("header","Show "),this.root.appendChild(this.header),this.typeSelector=document.createElement("select"),this.header.appendChild(this.typeSelector),this.typeSelector.addEventListener("change",function(){o.filterType(this.value)}),this.itemList=document.createElement("ul"),this.root.appendChild(this.itemList),e.on("showReport",function(t){o.showReport(e.reports[t])})};p.prototype.showReport=function(o){for(var i=this;this.itemList.lastChild;)i.itemList.removeChild(i.itemList.lastChild);var s=o.data.duration;if(!s)throw"No valid duration for profile";this.bar.header.addPanelTab(e(s),this.root);for(var r={},n=0;n<o.data.profiles.length;n++)!function(n){var a=o.data.profiles[n],d=i.bar.profileTypes.hasOwnProperty(a.type)?a.type:"default",p=i.bar.profileTypes[d];r.hasOwnProperty(a.type)||(r[a.type]=p.label||a.type);var l=document.createElement("li");l.setAttribute("data-phpsonde-type",a.type);var h=document.createElement("div");l.appendChild(h),h.classList.add("phpsonde-summary");var c=document.createElement("div");c.classList.add("phpsonde-label"),h.appendChild(c),c.innerHTML=p.label||a.type;var f=document.createElement("div");f.classList.add("phpsonde-duration"),f.innerHTML=e(a.stop-a.start),h.appendChild(f);var u=document.createElement("div"),v=document.createElement("div");v.classList.add("phpsonde-timebar"),v.appendChild(u),h.appendChild(v);var m=100*a.start/s,y=100*(a.stop-a.start)/s;u.style["margin-left"]=m+"%",u.style.width=y>0?y+"%":"1px",p.color&&(u.style["background-color"]=p.color);var L=document.createElement("div");if(L.classList.add("phpsonde-details"),l.appendChild(L),a.data&&Object.keys(a.data).length>0){var b=t("div",null,"phpsonde-data-details");b.appendChild(t("h3","Details")),L.appendChild(b);var w=t("table");b.appendChild(w);for(var g in a.data){var E=t("tr");w.appendChild(E),E.appendChild(t("td",g)),E.appendChild(t("td",a.data[g]))}}var C=document.createElement("div");C.classList.add("phpsonde-stacktrace");var S=document.createElement("pre");S.innerHTML=a.trace,C.appendChild(t("h3","Stack Trace")),C.appendChild(S),L.appendChild(C),h.addEventListener("click",function(){L.classList.toggle("phpsonde-open")}),i.itemList.appendChild(l)}(n);for(;this.typeSelector.options.length;)i.typeSelector.options.remove(0);var a=new Option("All",-1);this.typeSelector.options[0]=a;for(var d in r){var p=new Option(r[d],d);i.typeSelector.options[i.typeSelector.options.length]=p}},p.prototype.filterType=function(e){var t=this;if(-1==e)for(var o=0;o<this.itemList.children.length;o++)t.itemList.children[o].classList.remove("phpsonde-hidden");else for(var i=0;i<this.itemList.children.length;i++){var s=t.itemList.children[i];s.getAttribute("data-phpsonde-type")===e?t.itemList.children[i].classList.remove("phpsonde-hidden"):t.itemList.children[i].classList.add("phpsonde-hidden")}};var l=function(e){var o=this;this.bar=e,this.root=t("div","","phpsonde-panel phpsonde-messages-panel"),this.itemList=t("ul"),this.root.appendChild(this.itemList),e.on("showReport",function(t){o.showReport(e.reports[t])})};l.prototype.showReport=function(e){for(var o=this;this.itemList.lastChild;)o.itemList.removeChild(o.itemList.lastChild);var i=e.data.messages;if(i){var s=t("span",i.length,"phpsonde-bubble");this.bar.header.addPanelTab("messages "+s.outerHTML,this.root);for(var r=0;r<i.length;r++){var n=i[r],a=t("li","&rsaquo; "+n.text,"bar");o.itemList.appendChild(a)}}};var h=null,c=function(){this.root=document.createElement("div"),this.root.classList.add("phpsonde"),this.header=new i(this),this.root.appendChild(this.header.root),this.body=document.createElement("div"),this.body.classList.add("phpsonde-body"),this.root.appendChild(this.body),this.timeline=new p(this),this.body.appendChild(this.timeline.root),this.messages=new l(this),this.body.appendChild(this.messages.root),document.body.appendChild(this.root),this.reports=[],this.profileTypes={default:{color:"#AAA"}}};return c.prototype.open=function(){this.root.classList.add("phpsonde-open")},c.prototype.close=function(){this.root.classList.remove("phpsonde-open")},c.prototype.toggle=function(){this.root.classList.toggle("phpsonde-open")},c.prototype.addProfileType=function(e,t){this.profileTypes[e]=t},c.prototype.addReport=function(e,t){var o={label:e,data:t};this.reports.push(o),this.emit("reportAdded",o),1===this.reports.length&&this.showReport(0)},c.prototype.showReport=function(e){this.emit("showReport",e)},c.prototype.listenForXhrReports=function(){var e=this;o(function(t){var o=t.getResponseHeader("phpsondereport");if(o){for(var i,s=1;i=t.getResponseHeader("phpsondereport-"+s);)o+=i,s++;try{o=atob(o),o=JSON.parse(o)}catch(e){console.error("Sonde was unable to decode data fro ajax request, please see the error below and report it on https://github.com/hatcher-project/sonde/issues with as much details as possible, including your browser version"),console.error(e)}if(o.reportBundle)for(var r=0;r<o.reportBundle.length;r++)e.addReport("xhr",o.reportBundle[r]);else e.addReport("XHR",o)}})},d.mixin(c.prototype),{Bar:c}});
//# sourceMappingURL=index.js.map
